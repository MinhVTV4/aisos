<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Gi√°m s√°t Khu b·∫£o t·ªìn - Realtime Dashboard</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LeafletJS CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />


    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; 
        }
        .leaflet-popup-content-wrapper {
            background: #ffffff;
            color: #374151;
            border-radius: 8px;
            box-shadow: 0 4px 14px rgba(0,0,0,0.1);
        }
        .leaflet-popup-content { margin: 14px 20px; }
        .leaflet-popup-tip { background: #ffffff; }
        .leaflet-container a.leaflet-popup-close-button { color: #374151; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        @keyframes pulse-fire { 0% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(220, 38, 38, 0); } 100% { box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }
        @keyframes pulse-noise { 0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(234, 179, 8, 0); } 100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); } }
        .marker-pin-fire, .marker-pin-noise { width: 30px; height: 30px; border-radius: 50% 50% 50% 0; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -15px 0 0 -15px; }
        .marker-pin-fire { background-color: #dc2626; animation: pulse-fire 2s infinite; }
        .marker-pin-noise { background-color: #eab308; animation: pulse-noise 2s infinite; }
        .custom-div-icon i { position: absolute; left: 6px; top: 5px; color: white; }
        #gemini-modal { z-index: 2000; }
        .leaflet-routing-container { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex h-screen">
        <!-- Left Panel: Dashboard -->
        <div class="w-1/3 lg:w-1/4 bg-white p-4 flex flex-col shadow-lg z-10 border-r border-gray-200">
            <div class="flex items-center mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-500"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                <h1 class="text-xl font-bold ml-3 text-gray-900">B·∫£ng ƒëi·ªÅu khi·ªÉn Gi√°m s√°t</h1>
            </div>
            
            <div class="mb-4">
                <button id="test-ai-btn" class="w-full text-sm font-semibold text-indigo-600 hover:text-indigo-800 bg-indigo-100 hover:bg-indigo-200 px-3 py-2 rounded-lg flex items-center justify-center transition-colors">
                    <i data-lucide="bot" class="w-4 h-4 mr-2"></i>
                    Ki·ªÉm tra Tr·ª£ l√Ω AI
                </button>
            </div>

            <div class="mb-6 flex-shrink-0">
                <h2 class="text-lg font-semibold mb-2 border-b border-gray-200 pb-2 text-gray-900">Tr·∫°ng th√°i C·∫£m bi·∫øn</h2>
                <div id="sensor-list" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-gray-500">ƒêang ch·ªù d·ªØ li·ªáu...</p>
                </div>
            </div>

            <div class="flex-grow flex flex-col">
                <h2 class="text-lg font-semibold mb-2 border-b border-gray-200 pb-2 text-gray-900">Nh·∫≠t k√Ω C·∫£nh b√°o</h2>
                <div id="alert-log" class="flex-grow space-y-3 overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-gray-500">Ch∆∞a c√≥ c·∫£nh b√°o n√†o.</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Map -->
        <div class="w-2/3 lg:w-3/4">
            <div id="map" class="h-full w-full"></div>
        </div>
    </div>

    <!-- Modal for Gemini Action Plan -->
    <div id="gemini-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 backdrop-blur-sm flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-2xl transform transition-all">
            <div class="flex items-center justify-between mb-4">
                <h3 id="modal-title" class="text-xl font-bold text-gray-900 flex items-center">
                    {MODAL_TITLE}
                </h3>
                <button id="close-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div id="modal-content" class="text-gray-700 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2 leading-relaxed">
                <!-- Content will be injected by JS -->
            </div>
        </div>
    </div>

    <!-- LeafletJS JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    
    <!-- Lucide Icons script -->
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/umd/lucide.min.js"></script>

    <!-- ================================================================================= -->
    <!-- === SCRIPT CH√çNH C·ª¶A ·ª®NG D·ª§NG                                                 === -->
    <!-- ================================================================================= -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-ai.js";

        // === FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyBIiEB2Tu7j8CDUKKG7eafAYkLz2AXFGA8",
            authDomain: "aisos-5b68e.firebaseapp.com",
            databaseURL: "https://aisos-5b68e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aisos-5b68e",
            storageBucket: "aisos-5b68e.appspot.com",
            messagingSenderId: "471141463816",
            appId: "1:471141463816:web:1f70f77ec9f4bf66575ebd"
        };
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // === AI MODEL INIT ===
        let model;
        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            model = getGenerativeModel(ai, { model: "gemini-2.0-flash" });
            console.log("Firebase AI Model initialized successfully.");
        } catch(e) {
            console.error("L·ªói khi kh·ªüi t·∫°o AI Model:", e);
            alert(`Kh√¥ng th·ªÉ kh·ªüi t·∫°o Tr·ª£ l√Ω AI. L·ªói: ${e.message}`);
        }

        // === MAP & UI VARIABLES ===
        const sensorListDiv = document.getElementById('sensor-list');
        const alertLogDiv = document.getElementById('alert-log');
        let sensorMarkers = {};
        let alertMarkers = {};
        let routingControl = null;

        const defaultCenter = [20.315, 105.619];
        const defaultZoom = 13;
        const alertZoom = 14; 
        let returnToOverviewTimer = null;
        let activeIncident = null; 
        let incidentCooldownUntil = 0;

        const map = L.map('map').setView(defaultCenter, defaultZoom);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);
        
        const icons = {
            normal: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
            danger: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
            fire: L.divIcon({ className: 'custom-div-icon', html: "<div class='marker-pin-fire'></div><i data-lucide='flame'></i>", iconSize: [30, 42], iconAnchor: [15, 42], popupAnchor: [0, -35] }),
            noise: L.divIcon({ className: 'custom-div-icon', html: "<div class='marker-pin-noise'></div><i data-lucide='siren'></i>", iconSize: [30, 42], iconAnchor: [15, 42], popupAnchor: [0, -35] }),
            station: L.icon({ iconUrl: 'https://img.icons8.com/color/48/000000/building.png', iconSize: [32, 32], iconAnchor: [16, 32], popupAnchor: [0, -32] })
        };

        const rangerStations = {
            "station-north": { name: "Tr·∫°m Ki·ªÉm l√¢m ph√≠a B·∫Øc", lat: 20.380, lng: 105.655 },
            "station-west": { name: "Tr·∫°m Ki·ªÉm l√¢m ph√≠a T√¢y", lat: 20.300, lng: 105.590 },
            "station-southeast": { name: "Tr·∫°m Ki·ªÉm l√¢m ƒê√¥ng Nam", lat: 20.250, lng: 105.710 }
        };
        Object.values(rangerStations).forEach(station => {
            L.marker([station.lat, station.lng], { icon: icons.station })
              .addTo(map)
              .bindPopup(`<b>${station.name}</b>`);
        });

        // === SIMULATION LOGIC ===
        const virtualSensors = {
            "CP-S-001": { lat: 20.341, lng: 105.592, name: "Tr·∫°m 1: C·ªïng V∆∞·ªùn" }, "CP-S-002": { lat: 20.249, lng: 105.717, name: "Tr·∫°m 2: H·ªì M·∫°c" }, "CP-S-003": { lat: 20.395, lng: 105.651, name: "Tr·∫°m 3: ƒê·ªânh M√¢y B·∫°c" }, "CP-S-004": { lat: 20.298, lng: 105.623, name: "Tr·∫°m 4: C√¢y Tr√≤ Ng√†n NƒÉm" }, "CP-S-005": { lat: 20.315, lng: 105.619, name: "Tr·∫°m 5: Trung t√¢m C·ª©u h·ªô" }, "CP-S-006": { lat: 20.320, lng: 105.680, name: "Tr·∫°m 6: Thung l≈©ng b√≠ ·∫©n" }, "CP-S-007": { lat: 20.285, lng: 105.655, name: "Tr·∫°m 7: ƒê·ªông Ng∆∞·ªùi X∆∞a" }, "CP-S-008": { lat: 20.350, lng: 105.700, name: "Tr·∫°m 8: R√¨a ph√≠a ƒê√¥ng" }, "CP-S-009": { lat: 20.260, lng: 105.600, name: "Tr·∫°m 9: G·∫ßn b·∫£n M∆∞·ªùng" }, "CP-S-010": { lat: 20.370, lng: 105.615, name: "Tr·∫°m 10: V√°ch ƒë√° v√¥i" }, "CP-S-011": { lat: 20.333, lng: 105.633, name: "Tr·∫°m 11: Khu v·ª±c c√¢y S·∫•u" }, "CP-S-012": { lat: 20.291, lng: 105.698, name: "Tr·∫°m 12: Su·ªëi n∆∞·ªõc n√≥ng" }, "CP-S-013": { lat: 20.277, lng: 105.672, name: "Tr·∫°m 13: ƒê·ªông S∆°n Cung" }, "CP-S-014": { lat: 20.365, lng: 105.638, name: "Tr·∫°m 14: Tuy·∫øn ƒëi b·ªô" }, "CP-S-015": { lat: 20.305, lng: 105.589, name: "Tr·∫°m 15: R√¨a ph√≠a T√¢y" }, "CP-S-016": { lat: 20.255, lng: 105.630, name: "Tr·∫°m 16: Khu v·ª±c tre, n·ª©a" }, "CP-S-017": { lat: 20.380, lng: 105.685, name: "Tr·∫°m 17: V√πng ƒë·ªám ph√≠a B·∫Øc" }, "CP-S-018": { lat: 20.240, lng: 105.660, name: "Tr·∫°m 18: V√πng ƒë·ªám ph√≠a Nam" }, "CP-S-019": { lat: 20.312, lng: 105.650, name: "Tr·∫°m 19: Trung t√¢m v∆∞·ªùn" }, "CP-S-020": { lat: 20.355, lng: 105.599, name: "Tr·∫°m 20: G·∫ßn trung t√¢m du l·ªãch" }
        };
        
        function generateSensorData(incidentType = null) {
            let temperature, humidity, sound_level;
            if (incidentType === 'fire') {
                temperature = 45 + Math.random() * 10; humidity = 15 + Math.random() * 10; sound_level = 50 + Math.random() * 15;
            } else if (incidentType === 'noise') {
                temperature = 30 + Math.random() * 5; humidity = 50 + Math.random() * 15; sound_level = 85 + Math.random() * 15;
            } else {
                temperature = 28 + Math.random() * 7; humidity = 60 + Math.random() * 20; sound_level = 40 + Math.random() * 10;
            }
            return {
                temperature: parseFloat(temperature.toFixed(1)), humidity: parseFloat(humidity.toFixed(1)),
                sound_level: parseFloat(sound_level.toFixed(1)), timestamp: new Date().toISOString()
            };
        }

        function manageIncidents() {
            const now = Date.now();
            if (activeIncident && now > activeIncident.endTime) {
                incidentCooldownUntil = now + 120000;
                activeIncident = null;
            }
            if (!activeIncident && now > incidentCooldownUntil) {
                if (Math.random() < 0.2) { 
                    const sensorIds = Object.keys(virtualSensors);
                    const incidentType = Math.random() < 0.5 ? 'fire' : 'noise';
                    const affectedSensors = sensorIds.sort(() => 0.5 - Math.random()).slice(0, 1);
                    const duration = (Math.floor(Math.random() * 2) + 2) * 60 * 1000;
                    activeIncident = { type: incidentType, affectedSensors, endTime: now + duration };
                }
            }
        }

        async function updateAllSensors() {
            for (const sensorId in virtualSensors) {
                let incidentType = null;
                if (activeIncident && activeIncident.affectedSensors.includes(sensorId)) {
                    incidentType = activeIncident.type;
                }
                const data = generateSensorData(incidentType);
                const fullData = { ...data, lat: virtualSensors[sensorId].lat, lng: virtualSensors[sensorId].lng, name: virtualSensors[sensorId].name };
                
                await set(ref(db, 'sensors/' + sensorId), fullData);

                if (incidentType) {
                    const alert = {
                        sensorId, type: incidentType,
                        message: incidentType === 'fire' ? `Ph√°t hi·ªán nguy c∆° CH√ÅY R·ª™NG t·∫°i ${fullData.name}.` : `Ti·∫øng ·ªìn l·ªõn b·∫•t th∆∞·ªùng t·∫°i ${fullData.name}.`,
                        details: incidentType === 'fire' ? `Nhi·ªát ƒë·ªô: ${fullData.temperature}¬∞C, ƒê·ªô ·∫©m: ${fullData.humidity}%` : `M·ª©c √¢m thanh: ${fullData.sound_level}dB, nghi ng·ªù c∆∞a m√°y.`,
                        timestamp: new Date().toISOString(), lat: fullData.lat, lng: fullData.lng
                    };
                    await set(ref(db, `active_alerts/${sensorId}`), alert);
                } else {
                    await set(ref(db, `active_alerts/${sensorId}`), null);
                }
            }
        }
        
        setInterval(updateAllSensors, 8000); 
        setInterval(manageIncidents, 10000);

        // --- UI & FIREBASE DATA HANDLING ---
        onValue(ref(db, 'sensors'), (snapshot) => {
            const sensorsData = snapshot.val();
            if (!sensorsData) return;
            sensorListDiv.innerHTML = '';
            Object.entries(sensorsData).forEach(([sensorId, data]) => {
                let status = 'normal', statusColor = 'text-green-600', icon = icons.normal;
                if (data.temperature > 45 || data.sound_level > 85) { status = 'danger'; statusColor = 'text-red-600'; icon = icons.danger;
                } else if (data.temperature > 38 || data.sound_level > 70) { status = 'warning'; statusColor = 'text-yellow-500'; icon = icons.warning; }
                const sensorElement = document.createElement('div');
                sensorElement.className = 'bg-gray-50 p-3 rounded-lg flex items-center justify-between border border-gray-200 cursor-pointer hover:bg-gray-100 hover:border-blue-400 transition-colors';
                sensorElement.dataset.sensorId = sensorId;
                sensorElement.innerHTML = `<div><p class="font-semibold text-gray-700">${data.name}</p><p class="text-xs text-gray-500">T: ${data.temperature}¬∞C, H: ${data.humidity}%, S: ${data.sound_level}dB</p></div><div class="flex items-center"><span class="text-sm font-medium mr-2 ${statusColor}">${status.charAt(0).toUpperCase() + status.slice(1)}</span><div class="w-3 h-3 rounded-full ${status === 'normal' ? 'bg-green-500' : status === 'warning' ? 'bg-yellow-400' : 'bg-red-500'}"></div></div>`;
                sensorListDiv.appendChild(sensorElement);
                
                // NEW: Added "Find Route" button to the sensor popup
                const popupContent = `
                    <div class="text-base font-bold mb-2 text-gray-900">${data.name}</div>
                    <div class="text-sm"><b>Nhi·ªát ƒë·ªô:</b> ${data.temperature}¬∞C</div>
                    <div class="text-sm"><b>ƒê·ªô ·∫©m:</b> ${data.humidity}%</div>
                    <div class="text-sm"><b>√Çm thanh:</b> ${data.sound_level} dB</div>
                    <div class="text-xs text-gray-400 mt-2"><i>C·∫≠p nh·∫≠t: ${new Date(data.timestamp).toLocaleTimeString()}</i></div>
                    <div class="mt-3 pt-2 border-t border-gray-200">
                        <button class="sensor-route-btn text-xs font-semibold text-green-600 hover:text-green-800 bg-green-100 hover:bg-green-200 px-3 py-1 rounded-full flex items-center w-full justify-center transition-colors" data-lat="${data.lat}" data-lng="${data.lng}">
                            <i data-lucide="map-pinned" class="w-4 h-4 mr-1"></i>
                            Ch·ªâ ƒë∆∞·ªùng t·ªõi ƒë√¢y
                        </button>
                    </div>`;

                if (sensorMarkers[sensorId]) { sensorMarkers[sensorId].setLatLng([data.lat, data.lng]).setIcon(icon).setPopupContent(popupContent);
                } else { sensorMarkers[sensorId] = L.marker([data.lat, data.lng], { icon: icon }).addTo(map).bindPopup(popupContent); }
            });
        });

        // --- INTERACTION LOGIC ---
        function findAndDrawRoute(destinationLatLng) {
            let closestStation = null;
            let minDistance = Infinity;

            Object.values(rangerStations).forEach(station => {
                const stationLatLng = L.latLng(station.lat, station.lng);
                const distance = destinationLatLng.distanceTo(stationLatLng);
                if (distance < minDistance) {
                    minDistance = distance;
                    closestStation = station;
                }
            });

            if (closestStation) {
                if (routingControl) {
                    map.removeControl(routingControl);
                }
                routingControl = L.Routing.control({
                    waypoints: [ L.latLng(closestStation.lat, closestStation.lng), destinationLatLng ],
                    routeWhileDragging: false, show: false, addWaypoints: false,
                    lineOptions: { styles: [{ color: '#0056b3', opacity: 0.8, weight: 6 }] },
                    createMarker: () => null
                }).addTo(map);
            }
        }

        sensorListDiv.addEventListener('click', (e) => {
            const sensorItem = e.target.closest('[data-sensor-id]');
            if (sensorItem) {
                const sensorId = sensorItem.dataset.sensorId;
                const marker = sensorMarkers[sensorId];
                if (marker) {
                    map.flyTo(marker.getLatLng(), 16);
                    marker.openPopup();
                }
            }
        });

        // NEW: Event listener for route buttons inside popups
        map.getContainer().addEventListener('click', function(e) {
            const button = e.target.closest('.sensor-route-btn');
            if (button) {
                const lat = parseFloat(button.dataset.lat);
                const lng = parseFloat(button.dataset.lng);
                if (!isNaN(lat) && !isNaN(lng)) {
                    findAndDrawRoute(L.latLng(lat, lng));
                }
            }
        });

        // Call lucide.createIcons whenever a popup is opened
        map.on('popupopen', function() {
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        });

        const geminiModal = document.getElementById('gemini-modal');
        const modalContent = document.getElementById('modal-content');
        const modalTitle = document.getElementById('modal-title');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const testAiBtn = document.getElementById('test-ai-btn');

        function processMarkdown(text) {
            text = text.replace(/\*\*(.*?)\*\*/g, '<strong class="text-gray-900">$1</strong>');
            text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
            text = text.replace(/`([^`]+)`/g, '<code class="bg-gray-200 text-red-600 px-1 rounded">$1</code>');
            text = text.replace(/^(\d+\.\s.*)$/gm, '<p class="mb-2">$1</p>');
            text = text.replace(/\n/g, '<br>');
            return text;
        }

        async function callGemini(prompt) {
            if (!model) { return "<p class='text-red-600'>L·ªói: M√¥ h√¨nh AI ch∆∞a ƒë∆∞·ª£c kh·ªüi t·∫°o.</p>"; }
            try {
                const result = await model.generateContent(prompt);
                return processMarkdown(result.response.text());
            } catch (error) {
                console.error("L·ªói khi g·ªçi Gemini API qua Firebase AI:", error);
                if (error.message && (error.message.includes("500") || error.message.includes("overloaded"))) {
                     return `<p class="text-orange-600">Tr·ª£ l√Ω AI hi·ªán ƒëang qu√° t·∫£i. Vui l√≤ng th·ª≠ l·∫°i sau v√†i gi√¢y.</p>`;
                }
                return `<p class="text-red-600">Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn d·ªãch v·ª• AI. <br><br><b>Chi ti·∫øt l·ªói:</b> ${error.message}</p>`;
            }
        }

        function showModal(title, contentPromise) {
            modalTitle.innerHTML = title;
            geminiModal.classList.remove('hidden');
            modalContent.innerHTML = `<div class="flex justify-center items-center py-10"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div><p class="ml-4 text-gray-600">AI ƒëang suy nghƒ©...</p></div>`;
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
            
            contentPromise.then(htmlContent => {
                modalContent.innerHTML = htmlContent;
            });
        }
        
        testAiBtn.addEventListener('click', () => {
             const testPrompt = "Ch√†o AI, b·∫°n c√≥ kh·ªèe kh√¥ng? H√£y gi·ªõi thi·ªáu ng·∫Øn v·ªÅ m√¨nh v·ªõi vai tr√≤ l√† m·ªôt tr·ª£ l√Ω ·∫£o cho h·ªá th·ªëng gi√°m s√°t r·ª´ng, vi·∫øt b·∫±ng Ti·∫øng Vi·ªát.";
             const title = `<i data-lucide="bot" class="text-indigo-500 mr-2"></i>Ki·ªÉm tra Tr·ª£ l√Ω AI`;
             showModal(title, callGemini(testPrompt));
        });

        alertLogDiv.addEventListener('click', (e) => {
            const planButton = e.target.closest('.generate-plan-btn');
            if (planButton) {
                const alertDetails = planButton.dataset;
                let prompt = "";
                if (alertDetails.type === 'fire') {
                    prompt = `B·∫°n l√† m·ªôt chuy√™n gia v·ªÅ ki·ªÉm l√¢m v√† ·ª©ng ph√≥ kh·∫©n c·∫•p t·∫°i V∆∞·ªùn Qu·ªëc gia C√∫c Ph∆∞∆°ng, Vi·ªát Nam. M·ªôt c·∫£nh b√°o CH√ÅY R·ª™NG v·ª´a ƒë∆∞·ª£c ph√°t hi·ªán. - V·ªã tr√≠: ${alertDetails.name} (T·ªça ƒë·ªô: ${alertDetails.lat}, ${alertDetails.lng}) - Chi ti·∫øt: ${alertDetails.details}. H√£y t·∫°o m·ªôt k·∫ø ho·∫°ch h√†nh ƒë·ªông ng·∫Øn g·ªçn, r√µ r√†ng, v√† ∆∞u ti√™n cho ƒë·ªôi ki·ªÉm l√¢m. S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng Markdown. Bao g·ªìm c√°c m·ª•c: 1. **ƒê√°nh gi√° T√¨nh h√¨nh (∆Øu ti√™n s·ªë 1):** C√°c b∆∞·ªõc c·∫ßn l√†m ngay. 2. **Huy ƒë·ªông L·ª±c l∆∞·ª£ng:** C·∫ßn bao nhi√™u ng∆∞·ªùi, li√™n l·∫°c v·ªõi ai? 3. **Trang thi·∫øt b·ªã c·∫ßn thi·∫øt:** Li·ªát k√™ c√°c d·ª•ng c·ª• quan tr·ªçng. 4. **Ph∆∞∆°ng √°n Ti·∫øp c·∫≠n & An to√†n:** H∆∞·ªõng di chuy·ªÉn v√† c√°c l∆∞u √Ω an to√†n. Ph·∫£n h·ªìi b·∫±ng ti·∫øng Vi·ªát.`;
                } else if (alertDetails.type === 'noise') {
                    prompt = `B·∫°n l√† m·ªôt chuy√™n gia v·ªÅ ki·ªÉm l√¢m v√† ch·ªëng ph√° r·ª´ng t·∫°i V∆∞·ªùn Qu·ªëc gia C√∫c Ph∆∞∆°ng, Vi·ªát Nam. M·ªôt c·∫£nh b√°o TI·∫æNG ·ªíN B·∫§T TH∆Ø·ªúNG (nghi ng·ªù c∆∞a m√°y) v·ª´a ƒë∆∞·ª£c ph√°t hi·ªán. - V·ªã tr√≠: ${alertDetails.name} (T·ªça ƒë·ªô: ${alertDetails.lat}, ${alertDetails.lng}) - Chi ti·∫øt: ${alertDetails.details}. H√£y t·∫°o m·ªôt k·∫ø ho·∫°ch h√†nh ƒë·ªông th·∫≠n tr·ªçng cho ƒë·ªôi ki·ªÉm l√¢m. S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng Markdown. Bao g·ªìm c√°c m·ª•c: 1. **Ch·ªâ d·∫´n Ti·∫øp c·∫≠n (∆Øu ti√™n An to√†n):** C√°ch ti·∫øp c·∫≠n b√≠ m·∫≠t. 2. **Thu th·∫≠p B·∫±ng ch·ª©ng:** C·∫ßn l√†m g√¨ ƒë·ªÉ ghi l·∫°i b·∫±ng ch·ª©ng? 3. **Ph·ªëi h·ª£p & B√°o c√°o:** Khi n√†o c·∫ßn g·ªçi h·ªó tr·ª£? 4. **Nguy√™n t·∫Øc V√†ng:** C√°c quy t·∫Øc an to√†n quan tr·ªçng nh·∫•t. Ph·∫£n h·ªìi b·∫±ng ti·∫øng Vi·ªát.`;
                }
                const title = `<i data-lucide="sparkles" class="text-blue-500 mr-2"></i>K·∫ø ho·∫°ch H√†nh ƒë·ªông ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t`;
                if (prompt) { showModal(title, callGemini(prompt)); }
            }

            const routeButton = e.target.closest('.find-route-btn');
            if (routeButton) {
                 const lat = parseFloat(routeButton.dataset.lat);
                const lng = parseFloat(routeButton.dataset.lng);
                if (!isNaN(lat) && !isNaN(lng)) {
                    findAndDrawRoute(L.latLng(lat, lng));
                }
            }
        });

        closeModalBtn.addEventListener('click', () => { geminiModal.classList.add('hidden'); });
        window.addEventListener('keydown', (e) => { if (e.key === 'Escape' && !geminiModal.classList.contains('hidden')) { geminiModal.classList.add('hidden'); } });

        onValue(ref(db, 'active_alerts'), (snapshot) => {
            const allActiveAlerts = snapshot.val() || {};
            alertLogDiv.innerHTML = '<p class="text-gray-500">Ch∆∞a c√≥ c·∫£nh b√°o n√†o.</p>';
            Object.values(alertMarkers).forEach(marker => marker.remove());
            alertMarkers = {};
            if (returnToOverviewTimer) { clearTimeout(returnToOverviewTimer); }

            const activeAlertsList = Object.values(allActiveAlerts).filter(alert => alert && typeof alert === 'object');
            
            if (activeAlertsList.length > 0) {
                 if(alertLogDiv.querySelector('.text-gray-500')) alertLogDiv.innerHTML = '';
                 const latestAlert = activeAlertsList.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))[0];

                activeAlertsList.forEach(alertData => {
                    if (!alertData || typeof alertData.message !== 'string' || typeof alertData.lat !== 'number' || typeof alertData.lng !== 'number') { return; }
                    const alertId = alertData.sensorId;
                    const isFire = alertData.type === 'fire';
                    const alertIcon = isFire ? icons.fire : icons.noise;
                    const iconHTML = isFire ? `<i data-lucide="flame" class="w-5 h-5 text-white"></i>` : `<i data-lucide="siren" class="w-5 h-5 text-white"></i>`;
                    const bgColor = isFire ? 'bg-red-500' : 'bg-yellow-400';
                    const borderColor = isFire ? 'border-red-500' : 'border-yellow-400';
                    const alertElement = document.createElement('div');
                    alertElement.className = `bg-white p-3 rounded-lg border-l-4 ${borderColor} shadow-sm`;
                    const locationName = alertData.message.split('t·∫°i ')[1] || 'V·ªã tr√≠ kh√¥ng x√°c ƒë·ªãnh';
                    alertElement.innerHTML = `<div class="flex items-center mb-2"><div class="w-8 h-8 rounded-full ${bgColor} flex items-center justify-center mr-3 flex-shrink-0">${iconHTML}</div><div class="flex-grow"><p class="font-bold text-gray-800">${alertData.message}</p><p class="text-sm text-gray-600">${alertData.details}</p></div></div><div class="flex justify-between items-center mt-2"><p class="text-xs text-gray-400">V√†o l√∫c ${new Date(alertData.timestamp).toLocaleTimeString()}</p><div class="flex gap-2"><button class="find-route-btn text-xs font-semibold text-green-600 hover:text-green-800 bg-green-100 hover:bg-green-200 px-3 py-1 rounded-full flex items-center transition-colors" data-lat="${alertData.lat}" data-lng="${alertData.lng}"><i data-lucide="map-pinned" class="w-4 h-4 mr-1"></i>Ch·ªâ ƒë∆∞·ªùng</button><button class="generate-plan-btn text-xs font-semibold text-blue-600 hover:text-blue-800 bg-blue-100 hover:bg-blue-200 px-3 py-1 rounded-full flex items-center transition-colors" data-type="${alertData.type}" data-name="${locationName}" data-lat="${alertData.lat}" data-lng="${alertData.lng}" data-details="${alertData.details}"><i data-lucide="sparkles" class="w-4 h-4 mr-1"></i>G·ª£i √Ω</button></div></div>`;
                    alertLogDiv.prepend(alertElement);
                    const popupContent = `<div class="text-lg font-bold ${isFire ? 'text-red-600' : 'text-yellow-500'} mb-2">üö® C·∫¢NH B√ÅO ${alertData.type.toUpperCase()} üö®</div><div class="text-base text-gray-800">${alertData.message}</div><div class="text-sm text-gray-600">${alertData.details}</div><div class="text-xs text-gray-400 mt-2"><i>Th·ªùi gian: ${new Date(alertData.timestamp).toLocaleString()}</i></div>`;
                    if (!alertMarkers[alertId]) {
                        const alertMarker = L.marker([alertData.lat, alertData.lng], { icon: alertIcon, zIndexOffset: 1000 }).addTo(map).bindPopup(popupContent);
                        alertMarkers[alertId] = alertMarker;
                    }
                });

                if (latestAlert && typeof latestAlert.lat === 'number' && typeof latestAlert.lng === 'number') {
                    map.flyTo([latestAlert.lat, latestAlert.lng], alertZoom);
                    if (alertMarkers[latestAlert.sensorId]) { alertMarkers[latestAlert.sensorId].openPopup(); }
                    returnToOverviewTimer = setTimeout(() => { map.flyTo(defaultCenter, defaultZoom); }, 10000); 
                }
            }
            if (typeof lucide !== 'undefined') { lucide.createIcons(); }
        });
        
        if (typeof lucide !== 'undefined') { lucide.createIcons(); }
    </script>

</body>
</html>
