<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H·ªá th·ªëng Gi√°m s√°t Khu b·∫£o t·ªìn - Realtime Dashboard</title>

    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- LeafletJS CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- NOTE: Lucide Icons script moved to the end of the body for better loading order -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden; /* Prevent scrollbars from main layout */
        }
        /* Custom Leaflet popup style */
        .leaflet-popup-content-wrapper {
            background: #2d3748; /* bg-gray-800 */
            color: #e2e8f0; /* text-gray-300 */
            border-radius: 8px;
        }
        .leaflet-popup-content {
            margin: 14px 20px;
        }
        .leaflet-popup-tip {
            background: #2d3748;
        }
        .leaflet-container a.leaflet-popup-close-button {
            color: #e2e8f0;
        }
         /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* bg-gray-800 */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4a5568; /* bg-gray-600 */
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #718096; /* bg-gray-500 */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="flex h-screen">
        <!-- Left Panel: Dashboard -->
        <div class="w-1/3 lg:w-1/4 bg-gray-800 p-4 flex flex-col shadow-lg z-10">
            <div class="flex items-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-green-400"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
                <h1 class="text-xl font-bold ml-3">B·∫£ng ƒëi·ªÅu khi·ªÉn Gi√°m s√°t</h1>
            </div>

            <!-- Sensor Status Section -->
            <div class="mb-6 flex-shrink-0">
                <h2 class="text-lg font-semibold mb-2 border-b border-gray-600 pb-2">Tr·∫°ng th√°i C·∫£m bi·∫øn</h2>
                <div id="sensor-list" class="space-y-2 max-h-64 overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-gray-400">ƒêang ch·ªù d·ªØ li·ªáu...</p>
                </div>
            </div>

            <!-- Alert Log Section -->
            <div class="flex-grow flex flex-col">
                <h2 class="text-lg font-semibold mb-2 border-b border-gray-600 pb-2">Nh·∫≠t k√Ω C·∫£nh b√°o</h2>
                <div id="alert-log" class="flex-grow space-y-3 overflow-y-auto custom-scrollbar pr-2">
                    <p class="text-gray-400">Ch∆∞a c√≥ c·∫£nh b√°o n√†o.</p>
                </div>
            </div>
        </div>

        <!-- Right Panel: Map -->
        <div class="w-2/3 lg:w-3/4">
            <div id="map" class="h-full w-full"></div>
        </div>
    </div>

    <!-- LeafletJS JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <!-- FIX: Lucide Icons script is moved here, before the main script that uses it. -->
    <script src="https://unpkg.com/lucide-react@0.292.0/dist/umd/lucide.min.js"></script>

    <!-- ================================================================================= -->
    <!-- === SCRIPT CH√çNH C·ª¶A ·ª®NG D·ª§NG (S·ª¨ D·ª§NG FIREBASE V11 SDK)                      === -->
    <!-- ================================================================================= -->
    <script type="module">
        // Import the functions you need from the SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getDatabase, ref, set, push, onValue, onChildAdded } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-database.js";

        // === B∆Ø·ªöC 1: C·∫§U H√åNH FIREBASE (ƒê√É C·∫¨P NH·∫¨T T·ª™ TH√îNG TIN C·ª¶A B·∫†N) ===
        const firebaseConfig = {
            apiKey: "AIzaSyBIiEB2Tu7j8CDUKKG7eafAYkLz2AXFGA8",
            authDomain: "aisos-5b68e.firebaseapp.com",
            databaseURL: "https://aisos-5b68e-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "aisos-5b68e",
            storageBucket: "aisos-5b68e.appspot.com",
            messagingSenderId: "471141463816",
            appId: "1:471141463816:web:1f70f77ec9f4bf66575ebd"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // === KH·ªûI T·∫†O BI·∫æN V√Ä B·∫¢N ƒê·ªí ===
        const sensorListDiv = document.getElementById('sensor-list');
        const alertLogDiv = document.getElementById('alert-log');
        let sensorMarkers = {};
        let alertMarkers = {};

        // Initialize Map (V∆∞·ªùn Qu·ªëc gia C√∫c Ph∆∞∆°ng)
        const map = L.map('map').setView([20.315, 105.619], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            subdomains: 'abcd',
            maxZoom: 20
        }).addTo(map);
        
        const icons = {
            normal: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
            warning: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-yellow.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
            danger: L.icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] }),
            fire: L.divIcon({ className: 'custom-div-icon', html: "<div class='marker-pin-fire'></div><i data-lucide='flame'></i>", iconSize: [30, 42], iconAnchor: [15, 42], popupAnchor: [0, -35] }),
            noise: L.divIcon({ className: 'custom-div-icon', html: "<div class='marker-pin-noise'></div><i data-lucide='siren'></i>", iconSize: [30, 42], iconAnchor: [15, 42], popupAnchor: [0, -35] }),
        };

        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes pulse-fire { 0% { box-shadow: 0 0 0 0 rgba(255, 99, 71, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(255, 99, 71, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 99, 71, 0); } }
            @keyframes pulse-noise { 0% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0.7); } 70% { box-shadow: 0 0 0 20px rgba(250, 204, 21, 0); } 100% { box-shadow: 0 0 0 0 rgba(250, 204, 21, 0); } }
            .marker-pin-fire, .marker-pin-noise { width: 30px; height: 30px; border-radius: 50% 50% 50% 0; position: absolute; transform: rotate(-45deg); left: 50%; top: 50%; margin: -15px 0 0 -15px; }
            .marker-pin-fire { background-color: tomato; animation: pulse-fire 2s infinite; }
            .marker-pin-noise { background-color: #facc15; animation: pulse-noise 2s infinite; }
            .custom-div-icon i { position: absolute; left: 6px; top: 5px; color: white; }
        `;
        document.head.appendChild(style);

        // === GIAI ƒêO·∫†N 2 & 3: M√î PH·ªéNG D·ªÆ LI·ªÜU V√Ä "AI LOGIC" ===
        const virtualSensors = {
            "CucPhuong-001": { lat: 20.341, lng: 105.592, name: "Tr·∫°m C·ªïng V∆∞·ªùn" },
            "CucPhuong-002": { lat: 20.249, lng: 105.717, name: "Tr·∫°m H·ªì M·∫°c" },
            "CucPhuong-003": { lat: 20.395, lng: 105.651, name: "Tr·∫°m ƒê·ªânh M√¢y B·∫°c" },
            "CucPhuong-004": { lat: 20.298, lng: 105.623, name: "Tr·∫°m C√¢y Tr√≤ Ng√†n NƒÉm" }
        };

        function generateSensorData() {
            const isHighRisk = Math.random() < 0.05;
            const isNoiseRisk = !isHighRisk && Math.random() < 0.05;
            let temperature, humidity, sound_level;
            if (isHighRisk) {
                temperature = 45 + Math.random() * 10;
                humidity = 15 + Math.random() * 10;
                sound_level = 50 + Math.random() * 15;
            } else if (isNoiseRisk) {
                temperature = 30 + Math.random() * 5;
                humidity = 50 + Math.random() * 15;
                sound_level = 85 + Math.random() * 15;
            } else {
                temperature = 28 + Math.random() * 7;
                humidity = 60 + Math.random() * 20;
                sound_level = 40 + Math.random() * 10;
            }
            return {
                temperature: parseFloat(temperature.toFixed(1)),
                humidity: parseFloat(humidity.toFixed(1)),
                sound_level: parseFloat(sound_level.toFixed(1)),
                timestamp: new Date().toISOString()
            };
        }

        async function runAILogicAndSave(sensorId, sensorInfo) {
            const data = generateSensorData();
            const fullData = { ...data, lat: sensorInfo.lat, lng: sensorInfo.lng, name: sensorInfo.name };
            
            await set(ref(db, 'sensors/' + sensorId), fullData);

            if (fullData.temperature > 45 && fullData.humidity < 35) {
                const alert = { sensorId, type: "fire", message: `Ph√°t hi·ªán nguy c∆° CH√ÅY R·ª™NG t·∫°i ${sensorInfo.name}.`, details: `Nhi·ªát ƒë·ªô: ${fullData.temperature}¬∞C, ƒê·ªô ·∫©m: ${fullData.humidity}%`, confidence: 0.95, timestamp: new Date().toISOString(), lat: fullData.lat, lng: fullData.lng };
                await push(ref(db, 'alerts'), alert);
            }
            if (fullData.sound_level > 85) {
                const alert = { sensorId, type: "noise", message: `Ti·∫øng ·ªìn l·ªõn b·∫•t th∆∞·ªùng t·∫°i ${sensorInfo.name}.`, details: `M·ª©c √¢m thanh: ${fullData.sound_level}dB, nghi ng·ªù c∆∞a m√°y.`, confidence: 0.90, timestamp: new Date().toISOString(), lat: fullData.lat, lng: fullData.lng };
                await push(ref(db, 'alerts'), alert);
            }
        }
        
        setInterval(() => {
            for (const sensorId in virtualSensors) {
                runAILogicAndSave(sensorId, virtualSensors[sensorId]);
            }
        }, 8000);

        // === GIAI ƒêO·∫†N 4: HI·ªÇN TH·ªä D·ªÆ LI·ªÜU & C·∫¢NH B√ÅO T·ª™ FIREBASE ===
        const sensorsRef = ref(db, 'sensors');
        onValue(sensorsRef, (snapshot) => {
            const sensorsData = snapshot.val();
            if (!sensorsData) return;
            
            sensorListDiv.innerHTML = '';

            Object.entries(sensorsData).forEach(([sensorId, data]) => {
                let status = 'normal', statusColor = 'text-green-400', icon = icons.normal;
                if (data.temperature > 45 || data.sound_level > 85) {
                    status = 'danger'; statusColor = 'text-red-500'; icon = icons.danger;
                } else if (data.temperature > 38 || data.sound_level > 70) {
                    status = 'warning'; statusColor = 'text-yellow-400'; icon = icons.warning;
                }

                const sensorElement = document.createElement('div');
                sensorElement.className = 'bg-gray-700 p-3 rounded-lg flex items-center justify-between';
                sensorElement.innerHTML = `<div><p class="font-semibold">${data.name}</p><p class="text-xs text-gray-400">T: ${data.temperature}¬∞C, H: ${data.humidity}%, S: ${data.sound_level}dB</p></div><div class="flex items-center"><span class="text-sm font-medium mr-2 ${statusColor}">${status.charAt(0).toUpperCase() + status.slice(1)}</span><div class="w-3 h-3 rounded-full ${status === 'normal' ? 'bg-green-400' : status === 'warning' ? 'bg-yellow-400' : 'bg-red-500'}"></div></div>`;
                sensorListDiv.appendChild(sensorElement);
                
                const popupContent = `<div class="text-base font-bold mb-2">${data.name}</div><div class="text-sm"><b>Nhi·ªát ƒë·ªô:</b> ${data.temperature}¬∞C</div><div class="text-sm"><b>ƒê·ªô ·∫©m:</b> ${data.humidity}%</div><div class="text-sm"><b>√Çm thanh:</b> ${data.sound_level} dB</div><div class="text-xs text-gray-400 mt-2"><i>C·∫≠p nh·∫≠t: ${new Date(data.timestamp).toLocaleTimeString()}</i></div>`;

                if (sensorMarkers[sensorId]) {
                    sensorMarkers[sensorId].setLatLng([data.lat, data.lng]).setIcon(icon).setPopupContent(popupContent);
                } else {
                    sensorMarkers[sensorId] = L.marker([data.lat, data.lng], { icon: icon }).addTo(map).bindPopup(popupContent);
                }
            });
        });

        const alertsRef = ref(db, 'alerts');
        onChildAdded(alertsRef, (snapshot) => {
            const alertData = snapshot.val();
            const alertId = snapshot.key;

            if(alertLogDiv.querySelector('.text-gray-400')) alertLogDiv.innerHTML = '';
            
            const isFire = alertData.type === 'fire';
            const alertIcon = isFire ? icons.fire : icons.noise;
            const iconHTML = isFire ? `<i data-lucide="flame" class="w-5 h-5 text-white"></i>` : `<i data-lucide="siren" class="w-5 h-5 text-white"></i>`;
            const bgColor = isFire ? 'bg-red-600' : 'bg-yellow-500';

            const alertElement = document.createElement('div');
            alertElement.className = 'bg-gray-700 p-3 rounded-lg border-l-4 ' + (isFire ? 'border-red-500' : 'border-yellow-400');
            alertElement.innerHTML = `<div class="flex items-center mb-1"><div class="w-8 h-8 rounded-full ${bgColor} flex items-center justify-center mr-3">${iconHTML}</div><div class="flex-grow"><p class="font-bold">${alertData.message}</p><p class="text-sm text-gray-300">${alertData.details}</p></div></div><p class="text-xs text-gray-400 text-right">V√†o l√∫c ${new Date(alertData.timestamp).toLocaleTimeString()}</p>`;
            alertLogDiv.prepend(alertElement);

            const popupContent = `<div class="text-lg font-bold ${isFire ? 'text-red-400' : 'text-yellow-400'} mb-2">üö® C·∫¢NH B√ÅO ${alertData.type.toUpperCase()} üö®</div><div class="text-base">${alertData.message}</div><div class="text-sm text-gray-300">${alertData.details}</div><div class="text-xs text-gray-400 mt-2"><i>Th·ªùi gian: ${new Date(alertData.timestamp).toLocaleString()}</i></div>`;
            
            if (!alertMarkers[alertId]) {
                 // FIX: The variable 'data' was out of scope. Changed to 'alertData.lng'.
                 const alertMarker = L.marker([alertData.lat, alertData.lng], { icon: alertIcon, zIndexOffset: 1000 }).addTo(map).bindPopup(popupContent).openPopup();
                alertMarkers[alertId] = alertMarker;
                map.flyTo([alertData.lat, alertData.lng], 15);
            }
            
            // FIX: Check if lucide is defined before calling it.
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });
        
        // FIX: Check if lucide is defined before calling it.
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }
    </script>

</body>
</html>
